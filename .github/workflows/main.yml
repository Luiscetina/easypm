name: CI â€” Build easypm (fixed devkitpro)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore devkitPro cache
        id: restore-devkitpro-cache
        uses: actions/cache@v4
        with:
          path: /opt/devkitpro
          key: ${{ runner.os }}-devkitpro-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-devkitpro-

      - name: Install system prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y wget git build-essential python3 ca-certificates dnsutils || true

      - name: Install devkitPro (apt) and dkp-pacman
        if: steps.restore-devkitpro-cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          # Preferred and fallback endpoints for the installer
          URLS=(
            "https://apt.devkitpro.org/install-devkitpro-pkg"
            "https://new.devkitpro.org/install-devkitpro-pkg"
          )
          SUCCESS=0
          for URL in "${URLS[@]}"; do
            echo "Attempting to download installer from: $URL"
            if wget --tries=5 --timeout=30 --retry-connrefused --waitretry=5 --quiet "$URL" -O install-devkitpro-pkg; then
              chmod +x install-devkitpro-pkg
              sudo ./install-devkitpro-pkg
              SUCCESS=1
              break
            else
              echo "Download from $URL failed, trying next endpoint..."
            fi
          done
          if [ $SUCCESS -ne 1 ]; then
            echo "ERROR: failed to download devkitPro installer from known endpoints" >&2
            echo "DNS diagnostic:"
            host apt.devkitpro.org || true
            host new.devkitpro.org || true
            exit 4
          fi
          sudo apt-get update
          sudo apt-get install -y devkitpro-pacman

      - name: Install devkitPro packages (devkitA64, libnx, tools)
        run: |
          # keep packages non-interactive
          sudo dkp-pacman -Syu --noconfirm
          sudo dkp-pacman -S --noconfirm devkitA64 libnx switch-tools

      - name: Print environment info
        run: |
          echo "devkitPro: $(ls -1 /opt/devkitpro || true)"
          echo "devkitA64: $(which aarch64-none-elf-gcc || true)"
          aarch64-none-elf-gcc --version || true

      - name: Build (Makefile)
        run: |
          # Attempt a clean build using the repo Makefile
          make clean || true
          make -j$(nproc)

      - name: List build outputs
        run: |
          echo "Root files:"
          ls -la
          echo "Build folder (if present):"
          ls -la build || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: easypm-build-artifacts
          path: |
            *.nro
            *.nsp
            *.zip
            build/*.nro
            build/*.nsp
            romfs/*
            screenshot.png
            icon.jpg

      - name: Save devkitPro to cache (best-effort)
        if: always()
        uses: actions/cache@v4
        with:
          path: /opt/devkitpro
          key: ${{ runner.os }}-devkitpro-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-devkitpro-
