name: CI â€” Build easypm (fixed devkitpro)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends gnupg ca-certificates wget curl apt-transport-https host

      - name: Add devkitPro APT repository and key
        run: |
          echo "deb https://apt.devkitpro.org stable main" | sudo tee /etc/apt/sources.list.d/devkitpro.list
          curl -fsSL https://apt.devkitpro.org/devkitpro-pub.gpg | sudo tee /etc/apt/trusted.gpg.d/devkitpro.gpg > /dev/null
          sudo apt-get update || true

      - name: Install devkitpro-pacman with retry and fallback
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            echo "Attempt $i: installing devkitpro-pacman via apt"
            if sudo apt-get install -y devkitpro-pacman; then
              echo "devkitpro-pacman installed via apt"
              break
            fi

            echo "apt install failed; will retry after 20s"
            sleep 20

            if [ "$i" = "3" ]; then
              echo "Final attempt failed; trying official installer script"
              URL="https://apt.devkitpro.org/install-devkitpro-pacman"
              if curl -fSsL "$URL" -o /tmp/install-devkitpro-pkg; then
                sudo bash /tmp/install-devkitpro-pkg || { echo "Installer script failed"; host apt.devkitpro.org || true; exit 1; }
              else
                echo "Failed to download installer from $URL"
                echo "DNS / connectivity diagnostic:"
                host apt.devkitpro.org || true
                host pkg.devkitpro.org || true
                exit 1
              fi
            fi
          done

      - name: Verify devkitpro-pacman
        run: |
          if command -v dkp-pacman >/dev/null 2>&1; then
            echo "dkp-pacman available:"; dkp-pacman --version || true
          else
            echo "dkp-pacman not found; listing /opt/devkitpro"; ls -la /opt/devkitpro || true; exit 1
          fi

      - name: Install toolchain packages with dkp-pacman
        run: |
          # Adjust packages as needed for your project
          if command -v dkp-pacman >/dev/null 2>&1; then
            sudo dkp-pacman -S --noconfirm devkitA64 || true
          else
            echo "dkp-pacman missing; skipping devkit package install"; exit 1
          fi

      - name: Build
        run: |
          make -j$(nproc)
